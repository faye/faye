Faye.Transport.CORS = Faye.extend(Faye.Class(Faye.Transport, {
  request: function(message, timeout) {
    var xhrClass = Faye.ENV.XDomainRequest ? XDomainRequest : XMLHttpRequest,
        xhr      = new xhrClass(),
        retry    = this.retry(message, timeout),
        self     = this;

    xhr.open('POST', this.endpoint, true);
    if (xhr.setRequestHeader) xhr.setRequestHeader('Pragma', 'no-cache');
    if (xhr.setRequestHeader) for (var key in this.headers) {
      if (!this.headers.hasOwnProperty(key)) continue;
      xhr.setRequestHeader(key, this.headers[key]);
    }

    var cleanUp = function() {
      if (!xhr) return false;
      xhr.onload = xhr.onerror = xhr.ontimeout = xhr.onprogress = null;
      xhr = null;
      Faye.ENV.clearTimeout(timer);
      return true;
    };

    xhr.onload = function() {
      var parsedMessage = null;
      try {
        parsedMessage = JSON.parse(xhr.responseText);
      } catch (e) {}

      cleanUp();

      if (parsedMessage) {
        self.receive(parsedMessage);
        self.trigger('up');
      } else {
        retry();
        self.trigger('down');
      }
    };

    var onerror = function() {
      cleanUp();
      retry();
      self.trigger('down');
    };
    var timer = Faye.ENV.setTimeout(onerror, 1.5 * 1000 * timeout);
    xhr.onerror = onerror;
    xhr.ontimeout = onerror;

    xhr.onprogress = function() {};
    xhr.send('message=' + encodeURIComponent(Faye.toJSON(message)));
  }
}), {
  isUsable: function(client, endpoint, callback, context) {
    if (Faye.URI.parse(endpoint).isSameOrigin())
      return callback.call(context, false);

    if (Faye.ENV.XDomainRequest)
      return callback.call(context, Faye.URI.parse(endpoint).protocol ===
                                    Faye.URI.parse(Faye.ENV.location).protocol);

    if (Faye.ENV.XMLHttpRequest) {
      var xhr = new Faye.ENV.XMLHttpRequest();
      return callback.call(context, xhr.withCredentials !== undefined);
    }
    return callback.call(context, false);
  }
});

Faye.Transport.register('cross-origin-long-polling', Faye.Transport.CORS);

